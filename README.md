# Tiny Expression

This is a simple expression library, inspired by [SurveyJS epxression](https://surveyjs.io/form-library/documentation/design-survey/conditional-logic). It features:

- Strong typing: generated by the [tsPeg](https://github.com/EoinDavey/tsPEG) parser.
- Tiny and simple: runtime engine for efficient evaluation.
- Serialize and Deserialist: to/form JSON

## Simple Usage

```ts
import { Runtime, deserializeFromJson, parse, serializeToJson } from "../src";
import { StandardRuntimeContext } from "../src/addons/StandardRuntimeContext";

const expression = `
(
  {scopes} contain allow_read 
  &&
  {acc_type} == normal
) || {is_admin}
`;

// Parse expression to TargetValue
const tmp = parse(expression);
if (!tmp.ast?.value) {
  console.log(tmp.errs);
  throw new Error("syntax error");
}

// Save and load TargetValue <-> json
const jsonStr = serializeToJson(tmp.ast.value);
const fromJson = deserializeFromJson(jsonStr);
if (!fromJson) {
  throw new Error("OoO");
}

// Create runtime context
const ctx = new StandardRuntimeContext({
  scopes: ["allow_read"],
  acc_type: "normal",
  is_admin: false,
});
const runtime = new Runtime(ctx);

// Evalulate value
const result = runtime.eval(fromJson);
console.log(result); // -> true
```

## Expression syntax

### Expression elements

- `number`, `string`, `array`, `variable`, `boolean`

```ts
// Number literals
12345, -123, 0x123

// String literals with '' or ""
'abc', "abc"

// Variables reference
{is_admin}

// Boolean values
true, false
```

### Array types

- Arrays can contain any type of expression element, including other arrays.
- Some handly array operator `empty`, `contain`, `anyof`, `allof`

```ts
// Array examples
[1,2,3], [[1,2], true, "hello"]

// Array operators
[] empty -> true
[1,2] contain 1 -> true
[false, false] anyof true -> false
[false, false] allof false -> false
```

### Math Operators

- Basic math operators are supported: `+`, `-`, `*`, `/`, `%`, `^` or `power`

```ts
// Math expression evaluation
`(((1 + 3) power (5 - 2)) ^ (9 / 7)) / (3 % 2)` -> 210.0058511379554
```

### Logical and comparison operators

- Supported logical operators `and` or `&&` , `or` or `||` , `!` or `negate`
- Supported comparison operators: `>`, `>=`, `<`, `<=`, `==`, `!=`

```ts
`!true` or `negate true` -> false
`1>3 or true` or `1>3 || true` -> true
`1>3 and true` or `1>3 and true` -> false

`{is_admin} == true` -> :) depend on runtime context
`{score} > 50` -> :) depend on runtime context
```

### Functions

- You can register custom functions with parameters of type `RuntimeValue`.

```ts
type RuntimeValue = string| number| boolean| Array<RuntimeValue>| null
const ctx = new StandardRuntimeContext();
ctx.registerFunction(
    "say_hi",
    ([name]) => `hi ${String(name).toLocaleUpperCase()}!`
  );
inp = `say_hi('ttin')`;
res = doTest(inp, ctx);
console.log(inp, "->", res); // -> hi TTIN!
```

### Prebuilt functions

- Some prebuilt functions are available in the `StandardRuntimeContext`.

  - iif Conditional expression.

  ```ts
    `iif({is_admin}, 'hello admin', 'hello user')` -> return string value depend on variable
  ```

  - max and min: Find the maximum or minimum values

  ```ts
    `max(1,3,5)` -> 5
    `min(1,3,5)` -> 1
  ```

## Development guides

This project was created using `bun init` in bun v1.0.14. [Bun](https://bun.sh) is a fast all-in-one JavaScript runtime.

- To install dependencies:

```bash
bun install
```

- To test:

```bash
bun test --coverage
```

- Folder structure
  - grammar/: PEG syntax
  - src/
  - tests/
  - build.sh: build PEG syntax